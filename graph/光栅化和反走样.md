### 光栅化

我们知道，屏幕上显示出一个画面，是靠屏幕中每个不同的像素显示出不同的颜色，从而组合出各种不同的效果。而光栅化，则是将我们需要画的图形，转换为像素信息的过程。在渲染过程中，光栅化一般会做下面几个事情

####  三角形setup

在这个部分，会计算三角形所需要的数据，这些数据会在遍历三角形中所用到，包括了会在像素处理中用到的数据

#### 三角形遍历

在这个阶段，每个被三角形所覆盖的像素都会被检查，并且一个片段（用于片段着色器）将会在这个阶段中生成。每个三角形片段的生成过程会被称为三角形遍历。每个三角形都是通过顶点数据然后通过插值算法生成的。

在上述的三角形遍历阶段，我们需要遍历的三角形，则是已经经过了mvp转换后，然后投影到屏幕上所需要的三角形。

![](pixel.png)

如上图所示，假设我们屏幕分辨率1000*1000,即横竖各有1000个像素，而每个像素则是一个规整的小正方形，而位置（2,1)则代表上图蓝色像素的左下角，而真正的像素中心坐标则是（2.5,1.5），当我们要进行三角形的判断的时候，我们可以通过像素中心的坐标来进行判断

![](toscreen.png)

这种视口转换矩阵如下
$$
M_{viewport} = \left(\begin{matrix}
\frac{width}{2} &0 &0 &\frac{width}{2}\\
0 &\frac{height}{2} &0 &\frac{height}{2}\\
0 &0 &1 &0\\
0 &0 &0 &1
\end{matrix}
\right)
$$

#### 为什么是三角形来进行绘制呢

- 三角形是最基础的多边形
- 保证是平面的 
- 定义明确的内部 
- 有明确的插值方法



#### 如何进行像素在三角形中的判断呢

按照三角形遍历中我们提到的，像素是一块一块的，因此我们可以使用像素的中心来进行判断，如下图，在三角形中的像素则会被置为红色，不再的则是无色

![](insidetriangle.png)

当我们拿像素中心点来进行判断的时候，问题就简化了，变成了下面的情况

![](pointwithtriangle.png)

判断点是否在三角形中的办法很多，我们这里使用的是向量的方法。如图所示，当点q同时在向量$\vec{p_{1}p_{2}}$和$\vec{p_{2}p_{0}}$以及$\vec{p_{0}p_{1}}$的同一边时，点则在三角形中。如何判断方向呢，我们首先可以使用叉乘法，我们将$\vec{p_{1}Q}$和$\vec{p_{1}p_{2}}$进行叉乘，那么我们就会得到一个方向，这个方向则是z轴的方向，这个方向的正负则由左手系或者右手系确定，当用这种方式，我们以顺时针或者逆时针的形式计算了每一个向量和点的叉乘的方向后，如果三次结果的方向一致，则点在三角形内，否则在三角形外。

另外我们还可以拓展一下思路，比如说使用面积的方式，也可以进行比较。

#### 加速算法

前面提到，我们要遍历来判断一个点是否在三角形内，因此，在遍历开始之前，我们可以进行一个优化。例如说，找到这个三角形的aabb包围盒，这样就可以剔除掉大量原来不需要的点。另外还有一些其他的算法，适用于各种不同的情况，以下图为例

![](D:\t\learning\incrementaltriangle.png)

这是递增式的对三角形进行遍历，这种遍历方式，相比起遍历整个包围盒，还是要快一些的

### 走样（Aliasing）

上面，我们提到了光栅化后的三角形，而这些像素合在一起，可能就是下面的情况（放大后）

![](jaggies.png)

这就是我们接下来要提到的，锯齿，即走样。走样问题是三角形在像素中显示要么存在，要么不存在导致的。为了避免这个问题，我们就需要引入反走样技术

要解释为什么会发生走样，那么还是要设计到采样和滤波理论。渲染图像的处理本身就是一个采样任务。图像的生成就是三维场景采样的处理过程，其目的是为图像中的每一个像素（一个离散的像素数组），找到相应的颜色值。下图中展示了在频域中，一个信号是怎么被采样然后被重建的

![fig](fig515.png)

不论何时进行采样，都有可能会出现走样，这是我们不想要造成的的情况。有一个关于走样的经典案例，即电影摄像机拍摄的一个旋转的马车车轮，由于它移动的比摄像机记录图像的速度快很多，车轮看起来就是向后或者是不转。或者想象一下，我们人在看到一个高速旋转的轮子的时候，会发现轮子是向后转的。这是因为车轮的图像是以一系列步长被记录的，这被称作时间走样（temporal aliasing）

![fig](fig516.png)

当一个信号被以过慢的频率采样时，走样就会出现，为了使一个信号被合适的采样（或者说就是能够被正确的重建原始信号），采样频率必须大于被采样频率信号的两倍，这被称为采样定律，并且该采样频率以一位在 1928 年发现此频率的瑞典科学家 哈里·奈奎斯特（Harry Nyquist） (1889–1976) 命名，被称为奈奎斯特率（Nyquist rate）[1447] 或奈奎斯特极限（Nyquist limit）。奈奎斯特极限如图 5.16 所示。该定理使用术语“最大频率”的这一事实暗示着信号应该受到频带限制（band-limited），这仅仅意味着任何频率都不能超过特定限制。换句话说，信号相对于相邻样本间的间隔应该足够平滑。

![fig517](fig517.png)

以上图为例，图中的虚线可以理解为重建后的信号，这样很明显它是走样的，如果将虚线理解为另外一个信号，红点为采样的频率，可以看出采样的频率是和被采样频率相关的，是大于被采样频率信号的两倍

#### 渲染时的走样

前面我们提到了采样和重建，当采样频率不合适时，就可能会发生走样现象。我们可以通过傅里叶变换，将时域的信号转化为频域数据。而在上面的图5-15中的采样和重建则可以表示为下面的一个情况

![](samplingandrebuild.png)

从右边的图我们可以看出，采样=重复的频率内容。而走样是怎么导致的呢,下图中，上面的是密集的采样，而下面的是稀疏采样。即上图中的f图,稀疏采样导致了频率内容的混合，因此信号就产生了变化，所以就导致了走样

![](densesampling.png)

####  反走样和滤波

书接上文，那么开始考虑反走样的问题了，那么马上就能有一个办法，如下图所示

![](filtering.png)

这个办法就是给将信号给裁剪一点，去掉一部分的高频信号，然后让稀疏的采样也能够比较好的对图像进行采样。即滤波。

这里补充一点高频信号和低频信号的相关内容，高频信号，在图像中是变化比较大的，低频则是变化较小的，如下面图

![](lowpassfilter.png)

低通滤波的结果，如上图所示，则是模糊的结果，而高通滤波的相反，刚好是边缘的地方这些变化波动较大的信息，中通滤波器，结果就比较奇怪了

滤波=卷积 =平均化。而滤波则会需要不同的滤波器，就像卷积中有不同的卷积核一样，不同的滤波器/卷积核会带来不同的结果。常见的滤波器有Box滤波器，tent滤波器，理想的低通滤波器sinc滤波器等,这些滤波器如下图所示

![fig](fig519.png)

![fig](fig520.png)

![fig](fig521.png)

放到我们上面的例子中，不考虑各种奇奇怪怪的滤波器，那就是对三角形进行模糊，如下图所示

![](gamesfanzouyang.png)

而经过模糊之后，我们的三角形的周边变化不会那么尖锐，因此锯齿的效果就整体上减弱了

#### 基于屏幕空间的反走样（ Screen-Based Antialiasing）









